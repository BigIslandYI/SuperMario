<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スーパーマリオ風アクションゲーム</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #87CEEB, #98FB98);
            font-family: Arial, sans-serif;
            user-select: none;
            touch-action: manipulation;
        }

```
    #gameCanvas {
        display: block;
        margin: 0 auto;
        background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 70%, #8FBC8F 70%, #228B22 100%);
        border: 3px solid #8B4513;
    }

    #controller {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 50px;
        z-index: 1000;
    }

    .dpad {
        position: relative;
        width: 120px;
        height: 120px;
    }

    .dpad-button {
        position: absolute;
        width: 40px;
        height: 40px;
        background: #666;
        border: 2px solid #333;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
        cursor: pointer;
        user-select: none;
        touch-action: manipulation;
    }

    .dpad-button:active {
        background: #444;
    }

    .dpad-up {
        top: 0;
        left: 40px;
    }

    .dpad-down {
        bottom: 0;
        left: 40px;
    }

    .dpad-left {
        left: 0;
        top: 40px;
    }

    .dpad-right {
        right: 0;
        top: 40px;
    }

    .action-button {
        width: 80px;
        height: 80px;
        background: #FF6B6B;
        border: 3px solid #FF4757;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        user-select: none;
        touch-action: manipulation;
        align-self: center;
    }

    .action-button:active {
        background: #FF4757;
    }

    #gameInfo {
        position: fixed;
        top: 10px;
        left: 10px;
        color: white;
        font-size: 20px;
        font-weight: bold;
        text-shadow: 2px 2px 0px #000;
        z-index: 1000;
    }

    #gameOver, #gameWin {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        font-size: 24px;
        z-index: 1001;
        display: none;
    }

    .restart-button {
        margin-top: 20px;
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
    }

    .restart-button:hover {
        background: #45a049;
    }
</style>
```

</head>
<body>
    <div id="gameInfo">
        <div>ライフ: <span id="lives">3</span></div>
        <div>距離: <span id="distance">0</span>m / 100m</div>
    </div>

```
<canvas id="gameCanvas" width="800" height="400"></canvas>

<div id="controller">
    <div class="dpad">
        <div class="dpad-button dpad-up" id="upBtn">↑</div>
        <div class="dpad-button dpad-down" id="downBtn">↓</div>
        <div class="dpad-button dpad-left" id="leftBtn">←</div>
        <div class="dpad-button dpad-right" id="rightBtn">→</div>
    </div>
    <div class="action-button" id="jumpBtn">JUMP</div>
</div>

<div id="gameOver">
    <h2>ゲームオーバー</h2>
    <p>敵に3回当たってしまいました...</p>
    <button class="restart-button" onclick="restartGame()">リスタート</button>
</div>

<div id="gameWin">
    <h2>ゲームクリア！</h2>
    <p>おめでとうございます！</p>
    <button class="restart-button" onclick="restartGame()">もう一度プレイ</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // ゲーム状態
    let gameState = {
        lives: 3,
        gameOver: false,
        gameWin: false,
        cameraX: 0,
        worldWidth: 2000,
        invulnerable: false,
        invulnerableTime: 0
    };

    // プレイヤー
    let player = {
        x: 100,
        y: 300,
        width: 30,
        height: 40,
        velY: 0,
        onGround: false,
        moving: false,
        direction: 1 // 1: 右, -1: 左
    };

    // 敵の配列
    let enemies = [];

    // 入力状態
    let keys = {
        left: false,
        right: false,
        up: false,
        jump: false
    };

    // 敵を生成
    function createEnemies() {
        enemies = [];
        for (let i = 0; i < 15; i++) {
            enemies.push({
                x: 400 + i * 120 + Math.random() * 50,
                y: 320,
                width: 25,
                height: 25,
                velX: -1 + Math.random() * 2,
                type: Math.random() > 0.5 ? 'goomba' : 'koopa'
            });
        }
    }

    // ゲーム初期化
    function initGame() {
        gameState.lives = 3;
        gameState.gameOver = false;
        gameState.gameWin = false;
        gameState.cameraX = 0;
        gameState.invulnerable = false;
        gameState.invulnerableTime = 0;
        
        player.x = 100;
        player.y = 300;
        player.velY = 0;
        player.onGround = false;
        
        createEnemies();
        updateUI();
    }

    // UI更新
    function updateUI() {
        document.getElementById('lives').textContent = gameState.lives;
        const distance = Math.max(0, Math.floor((player.x - 100) / 20));
        document.getElementById('distance').textContent = distance;
    }

    // 衝突検出
    function checkCollision(rect1, rect2) {
        return rect1.x < rect2.x + rect2.width &&
               rect1.x + rect1.width > rect2.x &&
               rect1.y < rect2.y + rect2.height &&
               rect1.y + rect1.height > rect2.y;
    }

    // プレイヤーの更新
    function updatePlayer() {
        // 水平移動
        if (keys.left) {
            player.x -= 4;
            player.moving = true;
            player.direction = -1;
        }
        if (keys.right) {
            player.x += 4;
            player.moving = true;
            player.direction = 1;
        }
        
        if (!keys.left && !keys.right) {
            player.moving = false;
        }

        // ジャンプ
        if (keys.jump && player.onGround) {
            player.velY = -12;
            player.onGround = false;
        }

        // 重力
        player.velY += 0.6;
        player.y += player.velY;

        // 地面の衝突
        const groundY = 340;
        if (player.y >= groundY) {
            player.y = groundY;
            player.velY = 0;
            player.onGround = true;
        }

        // 画面境界
        if (player.x < gameState.cameraX) {
            player.x = gameState.cameraX;
        }

        // 無敵時間の更新
        if (gameState.invulnerable) {
            gameState.invulnerableTime--;
            if (gameState.invulnerableTime <= 0) {
                gameState.invulnerable = false;
            }
        }
    }

    // 敵の更新
    function updateEnemies() {
        enemies.forEach(enemy => {
            enemy.x += enemy.velX;
            
            // 画面端で方向転換
            if (enemy.x <= gameState.cameraX || enemy.x >= gameState.cameraX + canvas.width) {
                enemy.velX *= -1;
            }

            // プレイヤーとの衝突チェック
            if (!gameState.invulnerable && checkCollision(player, enemy)) {
                gameState.lives--;
                gameState.invulnerable = true;
                gameState.invulnerableTime = 120; // 2秒間無敵
                
                if (gameState.lives <= 0) {
                    gameState.gameOver = true;
                }
            }
        });
    }

    // カメラの更新
    function updateCamera() {
        // プレイヤーを中央付近に保つ
        const targetCameraX = player.x - canvas.width / 3;
        gameState.cameraX = Math.max(0, Math.min(targetCameraX, gameState.worldWidth - canvas.width));
    }

    // ゲーム更新
    function update() {
        if (gameState.gameOver || gameState.gameWin) return;

        updatePlayer();
        updateEnemies();
        updateCamera();
        
        // ゴール判定
        if (player.x >= gameState.worldWidth - 100) {
            gameState.gameWin = true;
        }

        updateUI();
    }

    // プレイヤーの描画
    function drawPlayer() {
        ctx.save();
        
        // 無敵時間中は点滅
        if (gameState.invulnerable && Math.floor(gameState.invulnerableTime / 10) % 2) {
            ctx.globalAlpha = 0.5;
        }

        // プレイヤーの向きに応じて反転
        if (player.direction === -1) {
            ctx.scale(-1, 1);
            ctx.translate(-(player.x - gameState.cameraX + player.width), 0);
        }

        // 体（赤）
        ctx.fillStyle = '#FF0000';
        ctx.fillRect(player.x - gameState.cameraX, player.y, player.width, player.height * 0.6);
        
        // 頭（肌色）
        ctx.fillStyle = '#FFDBAC';
        ctx.fillRect(player.x - gameState.cameraX + 5, player.y - 10, player.width - 10, 15);
        
        // 帽子（赤）
        ctx.fillStyle = '#CC0000';
        ctx.fillRect(player.x - gameState.cameraX + 2, player.y - 15, player.width - 4, 8);
        
        // 足（青）
        ctx.fillStyle = '#0000FF';
        ctx.fillRect(player.x - gameState.cameraX + 2, player.y + player.height * 0.6, player.width - 4, player.height * 0.4);

        ctx.restore();
    }

    // 敵の描画
    function drawEnemies() {
        enemies.forEach(enemy => {
            const screenX = enemy.x - gameState.cameraX;
            
            // 画面外は描画しない
            if (screenX < -enemy.width || screenX > canvas.width) return;

            if (enemy.type === 'goomba') {
                // クリボー風（茶色）
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(screenX, enemy.y, enemy.width, enemy.height);
                
                // 目
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(screenX + 5, enemy.y + 5, 4, 4);
                ctx.fillRect(screenX + 16, enemy.y + 5, 4, 4);
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(screenX + 7, enemy.y + 7, 2, 2);
                ctx.fillRect(screenX + 18, enemy.y + 7, 2, 2);
            } else {
                // ノコノコ風（緑）
                ctx.fillStyle = '#228B22';
                ctx.fillRect(screenX, enemy.y, enemy.width, enemy.height);
                
                // 甲羅の模様
                ctx.fillStyle = '#32CD32';
                ctx.fillRect(screenX + 3, enemy.y + 3, enemy.width - 6, enemy.height - 6);
            }
        });
    }

    // 背景の描画
    function drawBackground() {
        // 雲
        ctx.fillStyle = '#FFFFFF';
        for (let i = 0; i < 5; i++) {
            const cloudX = 200 + i * 400 - (gameState.cameraX * 0.3) % 2000;
            ctx.beginPath();
            ctx.arc(cloudX, 80, 30, 0, Math.PI * 2);
            ctx.arc(cloudX + 30, 80, 40, 0, Math.PI * 2);
            ctx.arc(cloudX + 70, 80, 30, 0, Math.PI * 2);
            ctx.fill();
        }

        // 地面のブロック
        ctx.fillStyle = '#8B4513';
        const blockSize = 40;
        for (let x = 0; x < gameState.worldWidth; x += blockSize) {
            const screenX = x - gameState.cameraX;
            if (screenX > -blockSize && screenX < canvas.width + blockSize) {
                ctx.fillRect(screenX, canvas.height - 60, blockSize, 60);
                
                // ブロックの境界線
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(screenX, canvas.height - 60, blockSize, 60);
            }
        }

        // ゴール
        const goalX = gameState.worldWidth - 100 - gameState.cameraX;
        if (goalX > -100 && goalX < canvas.width + 100) {
            // ポール
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(goalX + 45, 100, 10, 240);
            
            // フラッグ
            ctx.fillStyle = '#FF1493';
            ctx.fillRect(goalX + 55, 100, 40, 30);
            
            // "GOAL"テキスト
            ctx.fillStyle = '#000000';
            ctx.font = '20px Arial';
            ctx.fillText('GOAL', goalX + 10, 90);
        }
    }

    // 描画
    function draw() {
        // 画面クリア
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        drawBackground();
        drawPlayer();
        drawEnemies();

        // ゲームオーバー・クリア表示
        if (gameState.gameOver) {
            document.getElementById('gameOver').style.display = 'block';
        }
        if (gameState.gameWin) {
            document.getElementById('gameWin').style.display = 'block';
        }
    }

    // メインゲームループ
    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    // リスタート
    function restartGame() {
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('gameWin').style.display = 'none';
        initGame();
    }

    // タッチ・クリックイベント
    function addButtonEvents() {
        const buttons = {
            leftBtn: () => keys.left = true,
            rightBtn: () => keys.right = true,
            upBtn: () => keys.up = true,
            jumpBtn: () => keys.jump = true
        };

        Object.keys(buttons).forEach(id => {
            const btn = document.getElementById(id);
            
            // タッチイベント
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                buttons[id]();
            });
            
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (id === 'jumpBtn') {
                    keys.jump = false;
                } else {
                    keys.left = false;
                    keys.right = false;
                    keys.up = false;
                }
            });
            
            // マウスイベント（デバッグ用）
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                buttons[id]();
            });
            
            btn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                if (id === 'jumpBtn') {
                    keys.jump = false;
                } else {
                    keys.left = false;
                    keys.right = false;
                    keys.up = false;
                }
            });
        });
    }

    // キーボードイベント（デバッグ用）
    document.addEventListener('keydown', (e) => {
        switch(e.key) {
            case 'ArrowLeft':
                keys.left = true;
                break;
            case 'ArrowRight':
                keys.right = true;
                break;
            case ' ':
            case 'ArrowUp':
                keys.jump = true;
                e.preventDefault();
                break;
        }
    });

    document.addEventListener('keyup', (e) => {
        switch(e.key) {
            case 'ArrowLeft':
                keys.left = false;
                break;
            case 'ArrowRight':
                keys.right = false;
                break;
            case ' ':
            case 'ArrowUp':
                keys.jump = false;
                break;
        }
    });

    // ゲーム開始
    addButtonEvents();
    initGame();
    gameLoop();
</script>
```

</body>
</html>