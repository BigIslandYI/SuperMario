<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>スーパーマリオ風アクションゲーム</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #87CEEB, #98FB98);
            font-family: Arial, sans-serif;
            user-select: none;
            touch-action: manipulation;
        }

```
    #gameCanvas {
        display: block;
        margin: 0 auto;
        background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 70%, #8FBC8F 70%, #228B22 100%);
        border: 3px solid #8B4513;
    }

    #controller {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 50px;
        z-index: 1000;
    }

    .dpad {
        position: relative;
        width: 120px;
        height: 120px;
    }

    .dpad-button {
        position: absolute;
        width: 40px;
        height: 40px;
        background: #666;
        border: 2px solid #333;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
        cursor: pointer;
        user-select: none;
        touch-action: manipulation;
    }

    .dpad-button:active {
        background: #444;
    }

    .dpad-up {
        top: 0;
        left: 40px;
    }

    .dpad-down {
        bottom: 0;
        left: 40px;
    }

    .dpad-left {
        left: 0;
        top: 40px;
    }

    .dpad-right {
        right: 0;
        top: 40px;
    }

    .action-button {
        width: 80px;
        height: 80px;
        background: #FF6B6B;
        border: 3px solid #FF4757;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        user-select: none;
        touch-action: manipulation;
        align-self: center;
    }

    .action-button:active {
        background: #FF4757;
    }

    #gameInfo {
        position: fixed;
        top: 10px;
        left: 10px;
        color: white;
        font-size: 20px;
        font-weight: bold;
        text-shadow: 2px 2px 0px #000;
        z-index: 1000;
    }

    #gameOver, #gameWin {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        font-size: 24px;
        z-index: 1001;
        display: none;
    }

    .restart-button {
        margin-top: 20px;
        padding: 10px 20px;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
    }

    .restart-button:hover {
        background: #45a049;
    }
</style>
```

</head>
<body>
    <div id="gameInfo">
        <div>ライフ: <span id="lives">3</span></div>
        <div>距離: <span id="distance">0</span>m / 100m</div>
    </div>

```
<canvas id="gameCanvas" width="800" height="400"></canvas>

<div id="controller">
    <div class="dpad">
        <div class="dpad-button dpad-up" id="upBtn">↑</div>
        <div class="dpad-button dpad-down" id="downBtn">↓</div>
        <div class="dpad-button dpad-left" id="leftBtn">←</div>
        <div class="dpad-button dpad-right" id="rightBtn">→</div>
    </div>
    <div class="action-button" id="jumpBtn">JUMP</div>
    <div class="action-button" id="fireBtn" style="background: #FFA500; border-color: #FF8C00;">FIRE</div>
</div>

<div id="gameOver">
    <h2>ゲームオーバー</h2>
    <p>敵に3回当たってしまいました...</p>
    <button class="restart-button" onclick="restartGame()">リスタート</button>
</div>

<div id="gameWin">
    <h2>ゲームクリア！</h2>
    <p>おめでとうございます！</p>
    <button class="restart-button" onclick="restartGame()">もう一度プレイ</button>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // ゲーム状態
    let gameState = {
        lives: 3,
        gameOver: false,
        gameWin: false,
        cameraX: 0,
        worldWidth: 2000,
        invulnerable: false,
        invulnerableTime: 0
    };

    // プレイヤー
    let player = {
        x: 100,
        y: 300,
        width: 30,
        height: 40,
        velY: 0,
        onGround: false,
        moving: false,
        direction: 1 // 1: 右, -1: 左
    };

    // 敵の配列
    let enemies = [];

    // ブロックの配列
    let blocks = [];

    // ファイヤーボールの配列
    let fireballs = [];

    // 入力状態
    let keys = {
        left: false,
        right: false,
        up: false,
        jump: false,
        fire: false
    };

    // ブロックを生成
    function createBlocks() {
        blocks = [];
        const blockSize = 40;
        
        // 階段状のブロック
        for (let i = 0; i < 3; i++) {
            blocks.push({
                x: 300 + i * blockSize,
                y: 300 - i * blockSize,
                width: blockSize,
                height: blockSize
            });
        }

        // 浮島ブロック群
        for (let i = 0; i < 4; i++) {
            blocks.push({
                x: 600 + i * blockSize,
                y: 220,
                width: blockSize,
                height: blockSize
            });
        }

        // 高いタワー
        for (let i = 0; i < 5; i++) {
            blocks.push({
                x: 900,
                y: 300 - i * blockSize,
                width: blockSize,
                height: blockSize
            });
        }

        // 長い橋
        for (let i = 0; i < 6; i++) {
            blocks.push({
                x: 1200 + i * blockSize,
                y: 200,
                width: blockSize,
                height: blockSize
            });
        }

        // ジャンプ台
        blocks.push({
            x: 1500,
            y: 280,
            width: blockSize,
            height: blockSize
        });

        // 最後の障害物
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                blocks.push({
                    x: 1700 + j * blockSize,
                    y: 300 - i * blockSize,
                    width: blockSize,
                    height: blockSize
                });
            }
        }
    }
    // 敵を生成
    function createEnemies() {
        enemies = [];
        for (let i = 0; i < 15; i++) {
            enemies.push({
                x: 400 + i * 120 + Math.random() * 50,
                y: 320,
                width: 25,
                height: 25,
                velX: -1 + Math.random() * 2,
                type: Math.random() > 0.5 ? 'goomba' : 'koopa',
                alive: true
            });
        }
    }

    // ゲーム初期化
    function initGame() {
        gameState.lives = 3;
        gameState.gameOver = false;
        gameState.gameWin = false;
        gameState.cameraX = 0;
        gameState.invulnerable = false;
        gameState.invulnerableTime = 0;
        
        player.x = 100;
        player.y = 300;
        player.velY = 0;
        player.onGround = false;
        
        createBlocks();
        createEnemies();
        fireballs = [];
        updateUI();
    }

    // UI更新
    function updateUI() {
        document.getElementById('lives').textContent = gameState.lives;
        const distance = Math.max(0, Math.floor((player.x - 100) / 20));
        document.getElementById('distance').textContent = distance;
    }

    // 衝突検出
    function checkCollision(rect1, rect2) {
        return rect1.x < rect2.x + rect2.width &&
               rect1.x + rect1.width > rect2.x &&
               rect1.y < rect2.y + rect2.height &&
               rect1.y + rect1.height > rect2.y;
    }

    // プレイヤーの更新
    function updatePlayer() {
        // 水平移動
        if (keys.left) {
            player.x -= 4;
            player.moving = true;
            player.direction = -1;
        }
        if (keys.right) {
            player.x += 4;
            player.moving = true;
            player.direction = 1;
        }
        
        if (!keys.left && !keys.right) {
            player.moving = false;
        }

        // ジャンプ
        if (keys.jump && player.onGround) {
            player.velY = -12;
            player.onGround = false;
        }

        // ファイヤーボール発射
        if (keys.fire && fireballs.length < 3) { // 最大3発まで
            fireballs.push({
                x: player.x + (player.direction > 0 ? player.width : 0),
                y: player.y + player.height / 2,
                velX: player.direction * 8,
                velY: -2,
                width: 8,
                height: 8,
                bounces: 0
            });
            keys.fire = false; // 連射防止
        }

        // 重力
        player.velY += 0.6;
        
        // ブロックとの衝突チェック（垂直方向）
        let nextY = player.y + player.velY;
        player.onGround = false;
        
        blocks.forEach(block => {
            if (player.x < block.x + block.width && 
                player.x + player.width > block.x) {
                
                // 上から落ちてくる場合
                if (player.velY > 0 && player.y <= block.y && nextY + player.height >= block.y) {
                    player.y = block.y - player.height;
                    player.velY = 0;
                    player.onGround = true;
                }
                // 下から跳ね上がる場合
                else if (player.velY < 0 && player.y >= block.y + block.height && nextY <= block.y + block.height) {
                    player.y = block.y + block.height;
                    player.velY = 0;
                }
            }
        });

        if (!player.onGround) {
            player.y += player.velY;
        }

        // 地面の衝突
        const groundY = 340;
        if (player.y >= groundY) {
            player.y = groundY;
            player.velY = 0;
            player.onGround = true;
        }

        // ブロックとの水平衝突チェック
        blocks.forEach(block => {
            if (checkCollision(player, block)) {
                if (keys.left && player.x < block.x) {
                    player.x = block.x - player.width;
                }
                if (keys.right && player.x > block.x) {
                    player.x = block.x + block.width;
                }
            }
        });

        // 画面境界
        if (player.x < gameState.cameraX) {
            player.x = gameState.cameraX;
        }

        // 無敵時間の更新
        if (gameState.invulnerable) {
            gameState.invulnerableTime--;
            if (gameState.invulnerableTime <= 0) {
                gameState.invulnerable = false;
            }
        }
    }

    // 敵の更新
    function updateEnemies() {
        enemies.forEach(enemy => {
            if (!enemy.alive) return;
            
            enemy.x += enemy.velX;
            
            // ブロックとの衝突で方向転換
            let hitBlock = false;
            blocks.forEach(block => {
                if (checkCollision(enemy, block)) {
                    enemy.velX *= -1;
                    hitBlock = true;
                }
            });
            
            // 画面端で方向転換
            if (!hitBlock && (enemy.x <= gameState.cameraX || enemy.x >= gameState.cameraX + canvas.width)) {
                enemy.velX *= -1;
            }

            // プレイヤーとの衝突チェック
            if (!gameState.invulnerable && checkCollision(player, enemy)) {
                gameState.lives--;
                gameState.invulnerable = true;
                gameState.invulnerableTime = 120; // 2秒間無敵
                
                if (gameState.lives <= 0) {
                    gameState.gameOver = true;
                }
            }
        });
    }

    // ファイヤーボールの更新
    function updateFireballs() {
        for (let i = fireballs.length - 1; i >= 0; i--) {
            const fireball = fireballs[i];
            
            fireball.x += fireball.velX;
            fireball.y += fireball.velY;
            fireball.velY += 0.3; // 重力

            // 地面で跳ねる
            if (fireball.y >= 330) {
                fireball.y = 330;
                fireball.velY = -4;
                fireball.bounces++;
            }

            // ブロックとの衝突
            blocks.forEach(block => {
                if (checkCollision(fireball, block)) {
                    if (fireball.velY > 0) {
                        fireball.y = block.y - fireball.height;
                        fireball.velY = -4;
                    } else {
                        fireball.y = block.y + block.height;
                        fireball.velY = 2;
                    }
                    fireball.bounces++;
                }
            });

            // 敵との衝突
            enemies.forEach(enemy => {
                if (enemy.alive && checkCollision(fireball, enemy)) {
                    enemy.alive = false;
                    fireballs.splice(i, 1);
                    return;
                }
            });

            // 画面外または跳ねすぎたら削除
            if (fireball.x < gameState.cameraX - 50 || 
                fireball.x > gameState.cameraX + canvas.width + 50 || 
                fireball.bounces > 5) {
                fireballs.splice(i, 1);
            }
        }
    }

    // カメラの更新
    function updateCamera() {
        // プレイヤーを中央付近に保つ
        const targetCameraX = player.x - canvas.width / 3;
        gameState.cameraX = Math.max(0, Math.min(targetCameraX, gameState.worldWidth - canvas.width));
    }

    // ゲーム更新
    function update() {
        if (gameState.gameOver || gameState.gameWin) return;

        updatePlayer();
        updateEnemies();
        updateFireballs();
        updateCamera();
        
        // ゴール判定
        if (player.x >= gameState.worldWidth - 100) {
            gameState.gameWin = true;
        }

        updateUI();
    }

    // プレイヤーの描画
    function drawPlayer() {
        ctx.save();
        
        // 無敵時間中は点滅
        if (gameState.invulnerable && Math.floor(gameState.invulnerableTime / 10) % 2) {
            ctx.globalAlpha = 0.5;
        }

        // プレイヤーの向きに応じて反転
        if (player.direction === -1) {
            ctx.scale(-1, 1);
            ctx.translate(-(player.x - gameState.cameraX + player.width), 0);
        }

        // 体（赤）
        ctx.fillStyle = '#FF0000';
        ctx.fillRect(player.x - gameState.cameraX, player.y, player.width, player.height * 0.6);
        
        // 頭（肌色）
        ctx.fillStyle = '#FFDBAC';
        ctx.fillRect(player.x - gameState.cameraX + 5, player.y - 10, player.width - 10, 15);
        
        // 帽子（赤）
        ctx.fillStyle = '#CC0000';
        ctx.fillRect(player.x - gameState.cameraX + 2, player.y - 15, player.width - 4, 8);
        
        // 足（青）
        ctx.fillStyle = '#0000FF';
        ctx.fillRect(player.x - gameState.cameraX + 2, player.y + player.height * 0.6, player.width - 4, player.height * 0.4);

        ctx.restore();
    }

    // ブロックの描画
    function drawBlocks() {
        blocks.forEach(block => {
            const screenX = block.x - gameState.cameraX;
            
            // 画面外は描画しない
            if (screenX < -block.width || screenX > canvas.width) return;

            // ブロック本体（茶色）
            ctx.fillStyle = '#D2691E';
            ctx.fillRect(screenX, block.y, block.width, block.height);
            
            // ブロックの縁（濃い茶色）
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 2;
            ctx.strokeRect(screenX, block.y, block.width, block.height);
            
            // ハイライト（明るい茶色）
            ctx.fillStyle = '#F4A460';
            ctx.fillRect(screenX + 2, block.y + 2, block.width - 4, 8);
            ctx.fillRect(screenX + 2, block.y + 2, 8, block.height - 4);
        });
    }
    // 敵の描画
    function drawEnemies() {
        enemies.forEach(enemy => {
            if (!enemy.alive) return;
            
            const screenX = enemy.x - gameState.cameraX;
            
            // 画面外は描画しない
            if (screenX < -enemy.width || screenX > canvas.width) return;

            if (enemy.type === 'goomba') {
                // クリボー風（茶色）
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(screenX, enemy.y, enemy.width, enemy.height);
                
                // 目
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(screenX + 5, enemy.y + 5, 4, 4);
                ctx.fillRect(screenX + 16, enemy.y + 5, 4, 4);
                
                ctx.fillStyle = '#000000';
                ctx.fillRect(screenX + 7, enemy.y + 7, 2, 2);
                ctx.fillRect(screenX + 18, enemy.y + 7, 2, 2);
            } else {
                // ノコノコ風（緑）
                ctx.fillStyle = '#228B22';
                ctx.fillRect(screenX, enemy.y, enemy.width, enemy.height);
                
                // 甲羅の模様
                ctx.fillStyle = '#32CD32';
                ctx.fillRect(screenX + 3, enemy.y + 3, enemy.width - 6, enemy.height - 6);
            }
        });
    }

    // ファイヤーボールの描画
    function drawFireballs() {
        fireballs.forEach(fireball => {
            const screenX = fireball.x - gameState.cameraX;
            
            // 画面外は描画しない
            if (screenX < -fireball.width || screenX > canvas.width) return;

            // ファイヤーボール（オレンジの円）
            ctx.fillStyle = '#FF4500';
            ctx.beginPath();
            ctx.arc(screenX + fireball.width / 2, fireball.y + fireball.height / 2, fireball.width / 2, 0, Math.PI * 2);
            ctx.fill();
            
            // 内側のハイライト
            ctx.fillStyle = '#FFA500';
            ctx.beginPath();
            ctx.arc(screenX + fireball.width / 2, fireball.y + fireball.height / 2, fireball.width / 3, 0, Math.PI * 2);
            ctx.fill();
        });
    }

    // 背景の描画
    function drawBackground() {
        // 雲
        ctx.fillStyle = '#FFFFFF';
        for (let i = 0; i < 5; i++) {
            const cloudX = 200 + i * 400 - (gameState.cameraX * 0.3) % 2000;
            ctx.beginPath();
            ctx.arc(cloudX, 80, 30, 0, Math.PI * 2);
            ctx.arc(cloudX + 30, 80, 40, 0, Math.PI * 2);
            ctx.arc(cloudX + 70, 80, 30, 0, Math.PI * 2);
            ctx.fill();
        }

        // 地面のブロック
        ctx.fillStyle = '#8B4513';
        const blockSize = 40;
        for (let x = 0; x < gameState.worldWidth; x += blockSize) {
            const screenX = x - gameState.cameraX;
            if (screenX > -blockSize && screenX < canvas.width + blockSize) {
                ctx.fillRect(screenX, canvas.height - 60, blockSize, 60);
                
                // ブロックの境界線
                ctx.strokeStyle = '#654321';
                ctx.lineWidth = 2;
                ctx.strokeRect(screenX, canvas.height - 60, blockSize, 60);
            }
        }

        // ゴール
        const goalX = gameState.worldWidth - 100 - gameState.cameraX;
        if (goalX > -100 && goalX < canvas.width + 100) {
            // ポール
            ctx.fillStyle = '#FFD700';
            ctx.fillRect(goalX + 45, 100, 10, 240);
            
            // フラッグ
            ctx.fillStyle = '#FF1493';
            ctx.fillRect(goalX + 55, 100, 40, 30);
            
            // "GOAL"テキスト
            ctx.fillStyle = '#000000';
            ctx.font = '20px Arial';
            ctx.fillText('GOAL', goalX + 10, 90);
        }
    }

    // 描画
    function draw() {
        // 画面クリア
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        drawBackground();
        drawBlocks();
        drawPlayer();
        drawEnemies();
        drawFireballs();

        // ゲームオーバー・クリア表示
        if (gameState.gameOver) {
            document.getElementById('gameOver').style.display = 'block';
        }
        if (gameState.gameWin) {
            document.getElementById('gameWin').style.display = 'block';
        }
    }

    // メインゲームループ
    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    // リスタート
    function restartGame() {
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('gameWin').style.display = 'none';
        initGame();
    }

    // タッチ・クリックイベント
    function addButtonEvents() {
        const buttons = {
            leftBtn: () => keys.left = true,
            rightBtn: () => keys.right = true,
            upBtn: () => keys.up = true,
            jumpBtn: () => keys.jump = true,
            fireBtn: () => keys.fire = true
        };

        Object.keys(buttons).forEach(id => {
            const btn = document.getElementById(id);
            
            // タッチイベント
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                buttons[id]();
            });
            
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (id === 'jumpBtn') {
                    keys.jump = false;
                } else if (id === 'fireBtn') {
                    keys.fire = false;
                } else {
                    keys.left = false;
                    keys.right = false;
                    keys.up = false;
                }
            });
            
            // マウスイベント（デバッグ用）
            btn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                buttons[id]();
            });
            
            btn.addEventListener('mouseup', (e) => {
                e.preventDefault();
                if (id === 'jumpBtn') {
                    keys.jump = false;
                } else if (id === 'fireBtn') {
                    keys.fire = false;
                } else {
                    keys.left = false;
                    keys.right = false;
                    keys.up = false;
                }
            });
        });
    }

    // キーボードイベント（デバッグ用）
    document.addEventListener('keydown', (e) => {
        switch(e.key) {
            case 'ArrowLeft':
                keys.left = true;
                break;
            case 'ArrowRight':
                keys.right = true;
                break;
            case ' ':
            case 'ArrowUp':
                keys.jump = true;
                e.preventDefault();
                break;
            case 'x':
            case 'X':
                keys.fire = true;
                e.preventDefault();
                break;
        }
    });

    document.addEventListener('keyup', (e) => {
        switch(e.key) {
            case 'ArrowLeft':
                keys.left = false;
                break;
            case 'ArrowRight':
                keys.right = false;
                break;
            case ' ':
            case 'ArrowUp':
                keys.jump = false;
                break;
            case 'x':
            case 'X':
                keys.fire = false;
                break;
        }
    });

    // ゲーム開始
    addButtonEvents();
    initGame();
    gameLoop();
</script>
```

</body>
</html>